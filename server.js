const express=require("express"),crypto=require("crypto"),cors=require("cors"),fs=require("fs"),path=require("path"),app=express(),PORT=process.env.PORT||8e3,ENCRYPTION_KEY=Buffer.from(process.env.ENCRYPTION_KEY,"hex"),IV=Buffer.from(process.env.IV,"hex");if(!ENCRYPTION_KEY||32!==ENCRYPTION_KEY.length||!IV||16!==IV.length)throw new Error("ENCRYPTION_KEY (32 bytes hex) and IV (16 bytes hex) must be set as environment variables.");function encrypt(e){const r=crypto.createCipheriv("aes-256-cbc",ENCRYPTION_KEY,IV);let s=r.update(e,"utf8");return s=Buffer.concat([s,r.final()]),s.toString("hex")}function decrypt(e){const r=Buffer.from(e,"hex"),s=crypto.createDecipheriv("aes-256-cbc",ENCRYPTION_KEY,IV);let o=s.update(r);return o=Buffer.concat([o,s.final()]),o.toString()}const WHITELIST_PATH=path.join(__dirname,"whitelist.txt");function loadWhitelist(){return fs.existsSync(WHITELIST_PATH)?fs.readFileSync(WHITELIST_PATH,"utf8").split(/\r?\n/).map((e=>e.trim())).filter((e=>e&&!e.startsWith("//"))):[]}let WHITELIST=loadWhitelist();if(setInterval((()=>{WHITELIST=loadWhitelist()}),6e4),app.use(cors()),app.get("/api/normal-access",((e,r)=>{const{roblox_username:s,roblox_id:o}=e.query;if(!s||!o)return r.status(400).json({is_whitelisted:!1,error:"Missing params"});let t=null;for(const e of WHITELIST)try{const r=JSON.parse(decrypt(e));if(r.roblox_id===o||r.username===s){const e=!r.expires||Date.now()<r.expires;e&&(t={is_whitelisted:e,matched_type:r.roblox_id===o?"roblox_id":"roblox_username",matched_value:r.roblox_id===o?o:s,username:r.username||null,roblox_id:r.roblox_id||null,discord_id:r.discord_id||null,expires:r.expires||null});break}}catch(e){}if(!t)return r.status(403).json({error:"Denied Access"});r.json(t)})),app.get("/api/boost-access",((e,r)=>{const{discord_id:s,roblox_username:o,roblox_id:t}=e.query;if(!o||!t)return r.status(400).json({is_whitelisted:!1,has_boost_access:!1,error:"Missing params"});let i=null;for(const e of WHITELIST)try{const r=JSON.parse(decrypt(e)),n=r.roblox_id===t||r.username===o,a=s&&r.discord_id===s,c=r.boost_expires&&Date.now()<r.boost_expires;if(n){const e=a&&c;i={is_whitelisted:!0,has_boost_access:e,matched_type:r.roblox_id===t?"roblox_id":"roblox_username",matched_value:r.roblox_id===t?t:o,username:r.username||null,roblox_id:r.roblox_id||null,discord_id:r.discord_id||null,boost_expires:e?r.boost_expires:null};break}if(a&&c){i={is_whitelisted:!1,has_boost_access:!0,matched_type:"discord_id",matched_value:s,username:r.username||null,roblox_id:r.roblox_id||null,discord_id:r.discord_id||null,boost_expires:r.boost_expires};break}}catch(e){}if(!i||s&&!i.has_boost_access)return r.status(403).json({error:"Denied Access"});r.json(i)})),app.listen(PORT,(()=>{})),require.main===module&&"gen"===process.argv[2]){const e=JSON.parse(process.argv[3]);encrypt(JSON.stringify(e));process.exit(0)}
